<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoxelCraft - Main Menu</title>
    
    <!-- This link loads the 'Press Start 2P' font, which is required for the pixelated look -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <style>
        /*
        Custom CSS for the authentic Minecraft-like aesthetic (All styles are now internal)
        */
        :root {
            /* Authentic Minecraft Button Colors */
            --button-base: #C6C6C6; /* Light gray base */
            --button-hover: #FFFFFF; /* White on hover */
            --button-shadow-dark: #3F3F3F; /* Deepest shadow/border */
            --button-shadow-light: #8B8B8B; /* Secondary shadow for 3D effect */
            --title-color: #FFFF55; /* Official Minecraft logo yellow */
            --modal-bg: rgba(0, 0, 0, 0.75); /* Dark transparent background for modal */
            --form-color: #DDDDDD; /* Light gray for form text */
            --logged-in-color: #55FF55; /* Green for logged in status */
            --error-color: #FF0000; /* Red for errors */
        }

        body {
            /* Setting the font to the custom pixel font loaded above */
            font-family: 'Press Start 2P', monospace; 
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            /* Background image is loaded directly via CSS */
            background-image: url('./images/backgrounds/main_menu_background.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* --- Menu Layout --- */
        .menu-layout {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            width: 100%;
        }
        
        /* Title Styling - Mimicking the Minecraft Logo */
        .game-title {
            font-size: 3rem; 
            font-weight: bold;
            color: var(--title-color);
            text-align: center;
            margin-bottom: 4rem; /* Increased spacing */
            
            /* Authentic thick black outline with a slight inner shadow */
            text-shadow: 
                4px 4px 0 #3F3F3F, /* Bottom right shadow */
                -4px 4px 0 #3F3F3F, /* Bottom left shadow */
                4px -4px 0 #3F3F3F, /* Top right shadow */
                -4px -4px 0 #3F3F3F; /* Top left shadow */
            letter-spacing: 2px;
        }

        /* Button Styling - Authentic Raised Block */
        .menu-button {
            display: block; 
            width: 400px; 
            max-width: 90vw; 
            padding: 0.85rem 1.5rem; 
            font-size: 1rem; 
            text-transform: uppercase;
            color: #000000;
            background-color: var(--button-base);
            text-decoration: none;
            border-radius: 0;
            border: 2px solid var(--button-shadow-dark); 
            box-shadow: 
                -4px -4px 0 var(--button-shadow-light) inset, /* Top-left highlight */
                4px 4px 0 var(--button-shadow-dark) inset, /* Bottom-right shadow */
                0 6px 0 0 var(--button-shadow-dark); /* Vertical drop shadow (depth) */
            
            transition: transform 0.1s, box-shadow 0.1s, background-color 0.1s;
            cursor: pointer;
            text-align: center;
        }

        .menu-button:hover {
            background-color: var(--button-hover);
            color: var(--button-shadow-dark); 
            transform: translateY(-2px);
            box-shadow: 
                -4px -4px 0 var(--button-shadow-light) inset, 
                4px 4px 0 var(--button-shadow-dark) inset,
                0 8px 0 0 var(--button-shadow-dark);
        }

        .menu-button:active {
            background-color: var(--button-base);
            transform: translateY(4px); 
            box-shadow: 
                -4px -4px 0 var(--button-shadow-light) inset, 
                4px 4px 0 var(--button-shadow-dark) inset,
                0 2px 0 0 var(--button-shadow-dark); 
        }
        
        /* Button Group Spacing */
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem; 
            margin-bottom: 2rem;
        }

        /* Footer / Version Text */
        .footer-text {
            position: fixed;
            bottom: 0.5rem;
            left: 0.5rem;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.6rem; 
            text-align: left;
            text-shadow: 1px 1px 0 #000;
        }
        
        /* --- Shared Modal Styling (CSS Only) --- */
        .account-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-bg);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        /* Show modal when the anchor target is matched in the URL hash */
        #login-modal:target,
        #register-modal:target {
            display: flex;
        }

        .account-form-container {
            background-color: #111111;
            border: 4px solid var(--button-shadow-dark);
            box-shadow: 8px 8px 0 #000000;
            padding: 1.5rem;
            width: 500px;
            max-width: 90vw;
            color: var(--form-color);
            text-align: center;
        }

        .modal-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--title-color);
            text-shadow: 2px 2px 0 #3F3F3F;
        }

        .form-field {
            margin-bottom: 0.8rem;
            text-align: left;
            font-size: 0.8rem;
        }

        .form-field label {
            display: block;
            margin-bottom: 0.2rem;
        }

        .form-field input {
            width: 100%;
            padding: 0.4rem;
            font-family: 'Press Start 2P', monospace;
            font-size: 0.7rem;
            background-color: #000000;
            border: 2px solid var(--button-shadow-dark);
            color: var(--form-color);
            box-sizing: border-box;
            border-radius: 0;
        }
        
        .form-warning {
            color: #FF5555;
            font-size: 0.6rem;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        
        .close-button {
            margin-top: 1.5rem;
        }
        
        .form-switch-link {
            display: block;
            margin-top: 1rem;
            color: #AAAAFF; 
            font-size: 0.7rem;
            text-decoration: underline;
            cursor: pointer;
            text-shadow: 1px 1px 0 #000;
            text-transform: none; 
        }
        .form-switch-link:hover {
            color: #FFFFFF;
        }

        /* State management: Hide/Show buttons based on CSS :target and JS */
        
        /* Default state: Hide Logged In Status and Log Out button */
        #logged-in-button,
        #logout-button {
            display: none;
        }
        
        /* When the URL hash is #logged-in-state: */
        #logged-in-state:target ~ .menu-layout #account-button {
            display: none; /* Hide the original Account button */
        }

        #logged-in-state:target ~ .menu-layout #logged-in-button {
            display: block; /* Show the new Logged In status button */
            background-color: var(--logged-in-color);
            color: #000000;
            pointer-events: none; /* Make it non-clickable */
        }
        
        #logged-in-state:target ~ .menu-layout #logout-button {
            display: block; /* Show the Log Out button */
        }
        
        .hidden-target {
            display: none;
        }
        
        .error-message {
            color: var(--error-color);
            font-size: 0.7rem;
            margin-top: 0.5rem;
            min-height: 1.2rem; 
        }


        /* Mobile Responsiveness */
        @media (max-width: 640px) {
            .game-title {
                font-size: 2rem;
                margin-bottom: 2rem;
            }
            .menu-button {
                width: 90vw;
                font-size: 0.8rem;
                padding: 0.7rem 1rem;
            }
            .account-form-container {
                padding: 1rem;
            }
        }

    </style>
</head>
<body>
    <!-- Hidden element to serve as the successful login/registration URL target for CSS -->
    <div id="logged-in-state" class="hidden-target"></div>


    <div class="menu-layout">
        <div class="game-title">
            VoxelCraft
        </div>

        <div class="button-group">
            <a href="./voxelcraft.html" class="menu-button">
                Play Demo
            </a>

            <!-- ACCOUNT BUTTON: Visible when logged out (default) -->
            <a href="#login-modal" id="account-button" class="menu-button">
                Account
            </a>
            
            <!-- LOGGED IN STATUS: Visible when logged in (Updated by JS) -->
            <a href="#" id="logged-in-button" class="menu-button">
                Welcome, Player!
            </a>

            <!-- LOGOUT BUTTON: Only visible when logged in (Controlled by JS) -->
            <button id="logout-button" class="menu-button">
                Log Out
            </button>

            <a href="#" class="menu-button">
                Exit
            </a>
        </div>

        <div class="footer-text">
            Version 1.2.5 - Beta Build
        </div>
    </div>

    <!-- 
        ========================================
        1. LOGIN MODAL 
        ========================================
    -->
    <div id="login-modal" class="account-modal">
        <div class="account-form-container">
            <div class="modal-title">
                Account Login
            </div>
            
            <!-- FORM HANDLED BY JS -->
            <form id="login-form"> 
                <div class="form-field">
                    <label for="login-email">Email:</label>
                    <input type="email" id="login-email" name="email" required placeholder="steve@voxelcraft.com">
                </div>
                <div class="form-field">
                    <label for="login-password">Password:</label>
                    <input type="password" id="login-password" name="password" required>
                </div>
                
                <div id="login-error" class="error-message"></div>

                <div class="form-warning">
                    *Note: Uses Firebase Authentication (Email/Password).*
                </div>

                <button type="submit" id="login-submit-button" class="menu-button" style="margin-top: 1rem; padding: 0.6rem 1rem; font-size: 0.8rem;">
                    Login
                </button>
            </form>
            
            <a href="#register-modal" class="form-switch-link">
                Don't have an account? Register here!
            </a>

            <a href="#" class="menu-button close-button">
                Close
            </a>
        </div>
    </div>

    <!-- 
        ========================================
        2. REGISTRATION MODAL 
        ========================================
    -->
    <div id="register-modal" class="account-modal">
        <div class="account-form-container">
            <div class="modal-title">
                Account Registration
            </div>
            
            <!-- FORM HANDLED BY JS -->
            <form id="register-form">
                <div class="form-field">
                    <label for="reg-display-name">Username:</label>
                    <input type="text" id="reg-display-name" name="display-name" required placeholder="NewPlayer">
                </div>
                <div class="form-field">
                    <label for="reg-email">Email:</label>
                    <input type="email" id="reg-email" name="email" required placeholder="newplayer@voxelcraft.com">
                </div>
                <div class="form-field">
                    <label for="reg-password">Password:</label>
                    <input type="password" id="reg-password" name="password" required>
                </div>
                 <div class="form-field">
                    <label for="reg-confirm-password">Confirm Password:</label>
                    <input type="password" id="reg-confirm-password" name="confirm-password" required>
                </div>

                <div id="register-error" class="error-message"></div>

                <div class="form-warning">
                    *Note: Passwords must match and be at least 6 characters.*
                </div>

                <button type="submit" id="register-submit-button" class="menu-button" style="margin-top: 1rem; padding: 0.6rem 1rem; font-size: 0.8rem;">
                    Register Account
                </button>

            </form>
            
            <a href="#login-modal" class="form-switch-link">
                Already registered? Login here!
            </a>

            <a href="#" class="menu-button close-button">
                Close
            </a>
        </div>
    </div>

    <!-- 
        ========================================
        FIREBASE SDK and CUSTOM SCRIPT
        ========================================
    -->

    <script type="module">
        // === 1. FIREBASE MODULAR IMPORTS ===
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            updateProfile 
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
        import { getDatabase } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

        // === 2. FIREBASE CONFIGURATION (USER PROVIDED) ===
        const firebaseConfig = {
            apiKey: "AIzaSyACDoxbnTKoKbkRgKy6AZX8BbC24xWNj1A",
            authDomain: "voxelcraft-accounts.firebaseapp.com",
            databaseURL: "https://voxelcraft-accounts-default-rtdb.firebaseio.com",
            projectId: "voxelcraft-accounts",
            storageBucket: "voxelcraft-accounts.firebasestorage.app",
            messagingSenderId: "604948887462",
            appId: "1:604948887462:web:3fb6b15200650961764167",
            measurementId: "G-GVYY4MTB63"
        };

        // === 3. INITIALIZE FIREBASE SERVICES ===
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const analytics = getAnalytics(app); // Included for completeness
        const database = getDatabase(app); // Included for completeness

        // DOM element references
        const loggedInButton = document.getElementById('logged-in-button');
        const logoutButton = document.getElementById('logout-button');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');


        // === 4. AUTH STATE HANDLER (Manages UI changes on login/logout) ===
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in: Update UI to LOGGED IN state
                console.log("User logged in:", user.email, "Display Name:", user.displayName);
                
                // 1. Update the URL hash to trigger the CSS state change
                window.location.hash = 'logged-in-state';
                
                // 2. Update the Logged In button text to show the display name or a fallback
                const name = user.displayName || user.email.split('@')[0] || "Player";
                loggedInButton.textContent = `Welcome, ${name}!`;
                
                // 3. Attach logout functionality to the Log Out button
                // (Using a cleanup function to prevent multiple listeners)
                logoutButton.onclick = handleLogout;

            } else {
                // User is signed out: Update UI to LOGGED OUT state
                console.log("User logged out");
                
                // 1. Update the URL hash to clear the state and show the 'Account' button
                window.location.hash = '';

                // 2. Clear any lingering errors/messages
                document.getElementById('login-error').textContent = '';
                document.getElementById('register-error').textContent = '';
                
                // 3. Clear click handler to avoid memory leaks (optional, but good practice)
                logoutButton.onclick = null;
            }
        });


        // === 5. AUTH FUNCTIONS ===

        // Utility function to handle dynamic error messages
        const displayError = (elementId, message) => {
            document.getElementById(elementId).textContent = message;
        };

        // 1. LOGIN
        const handleLogin = (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            displayError('login-error', ''); // Clear previous error

            signInWithEmailAndPassword(auth, email, password)
                .then(() => {
                    // Success is handled by onAuthStateChanged
                    console.log("Login successful!");
                    window.location.hash = ''; // Clear modal hash
                })
                .catch((error) => {
                    let errorMessage = "An unknown error occurred.";
                    
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        errorMessage = "Invalid email or password.";
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = "Please enter a valid email address.";
                    } else {
                        errorMessage = error.message;
                    }
                    displayError('login-error', `Error: ${errorMessage}`);
                });
        };
        
        // 2. REGISTRATION
        const handleRegistration = (e) => {
            e.preventDefault();
            const displayName = document.getElementById('reg-display-name').value;
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            const confirmPassword = document.getElementById('reg-confirm-password').value;
            displayError('register-error', ''); // Clear previous error

            if (password !== confirmPassword) {
                displayError('register-error', "Error: Passwords do not match.");
                return;
            }

            // Step 1: Create the user
            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // Step 2: Set the display name immediately after creation
                    return updateProfile(userCredential.user, {
                        displayName: displayName
                    });
                })
                .then(() => {
                    // Success is handled by onAuthStateChanged
                    console.log("Registration successful! Display name set.");
                    window.location.hash = ''; // Clear modal hash
                })
                .catch((error) => {
                    let errorMessage = "An unknown error occurred.";
                    
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = "This email is already registered.";
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = "Password must be at least 6 characters.";
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = "Please enter a valid email address.";
                    } else {
                        errorMessage = error.message;
                    }
                    displayError('register-error', `Error: ${errorMessage}`);
                });
        };
        
        // 3. LOGOUT
        const handleLogout = () => {
            signOut(auth)
                .then(() => {
                    // Sign-out successful. Handled by onAuthStateChanged
                    console.log("Sign-out successful.");
                })
                .catch((error) => {
                    console.error("Logout Error:", error);
                    displayError('logged-in-button', "Logout Failed: " + error.message);
                });
        };


        // === 6. EVENT LISTENERS (Attaching JS functions to form submission) ===
        loginForm.addEventListener('submit', handleLogin);
        registerForm.addEventListener('submit', handleRegistration);

    </script>
</body>
</html>